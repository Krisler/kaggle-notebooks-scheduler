name: Run Kaggle Notebooks Daily

on:
  schedule:
    - cron: "0 4 * * 2-6"
  workflow_dispatch:

jobs:
  run-notebooks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Kaggle API
        shell: bash
        run: |
          mkdir -p ~/.kaggle
          echo "${{ secrets.KAGGLE_JSON }}" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
          echo "Kaggle JSON created:"
          cat ~/.kaggle/kaggle.json

      - name: Install Kaggle CLI & jq
        run: |
          pip install --upgrade kaggle
          sudo apt-get update && sudo apt-get install -y jq

      - name: Run StockAnal Notebook
        id: stockanal
        run: |
          NOTEBOOK_ID="krisler/stockanal"
          WORKDIR="./stockanal"

          echo "Cleaning old workdir..."
          rm -rf $WORKDIR
          mkdir -p $WORKDIR

          echo "Pulling latest $NOTEBOOK_ID..."
          kaggle kernels pull $NOTEBOOK_ID -p $WORKDIR --metadata

          echo "Triggering run by pushing..."
          kaggle kernels push -p $WORKDIR

          echo "Polling for completion..."
          STATUS=""
          while [[ "$STATUS" != *"complete"* ]]; do
            STATUS=$(kaggle kernels status $NOTEBOOK_ID | grep "Status" \
              | sed 's/Status:[[:space:]]*//; s/"//g' | tr '[:upper:]' '[:lower:]')

            echo "Current status: $STATUS"

            if [[ "$STATUS" == *"error"* ]]; then
              echo "Notebook failed!"
              exit 1
            fi

            sleep 60
          done

          echo "Notebook finished. Downloading outputs..."
          mkdir -p ./kaggle_outputs/StockAnal
          kaggle kernels output $NOTEBOOK_ID -p ./kaggle_outputs/StockAnal

      - name: Upload StockAnal Artifact
        uses: actions/upload-artifact@v4
        with:
          name: StockAnal-outputs
          path: ./kaggle_outputs/StockAnal
